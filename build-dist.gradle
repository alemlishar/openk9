
apply plugin: 'java'

configurations {
	dist {
		transitive = false
		visible = false
	}
	distExternal {
		transitive = false
		visible = false
	}
}

repositories {
	mavenLocal()
	mavenCentral()
}

dependencies {
	dist project(path: ':osgi:ingestion:ingestion-api', transitive: false)
	dist project(path: ':osgi:ingestion:ingestion-logic-api', transitive: false)
	dist project(path: ':osgi:ingestion:ingestion-logic-service', transitive: false)
	dist project(path: ':osgi:ingestion:ingestion-driver-manager-api', transitive: false)
	dist project(path: ':osgi:ingestion:ingestion-driver-manager-service', transitive: false)
	dist project(path: ':osgi:ingestion:ingestion-service', transitive: false)
	dist project(path: ':osgi:ingestion:ingestion-queue', transitive: false)
	dist project(path: ':osgi:web:http-api', transitive: false)
	dist project(path: ':osgi:web:http-service', transitive: false)
	dist project(path: ':osgi:web:http-bundle-ext', transitive: false)
	dist project(path: ':osgi:web:open-api', transitive: false)
	dist project(path: ':osgi:common:third-party', transitive: false)
	dist project(path: ':osgi:common:osgi-api', transitive: false)
	dist project(path: ':osgi:common:serialization-api', transitive: false)
	dist project(path: ':osgi:plugin:plugin-api', transitive: false)
	dist project(path: ':osgi:plugin:plugin-service', transitive: false)
	dist project(path: ':osgi:plugin:plugin-web', transitive: false)
	dist project(path: ':osgi:common:serialization-service', transitive: false)
	dist project(path: ':osgi:common:model', transitive: false)
	dist project(path: ':osgi:common:http-serialization', transitive: false)
	dist project(path: ':osgi:common:core-api', transitive: false)

	//dist project(path: ':osgi:common:reactor-agent', transitive: false)

	dist project(path: ':osgi:common:common-api', transitive: false)
	dist project(path: ':osgi:database:sql-api:', transitive: false)
	dist project(path: ':osgi:database:sql-service:', transitive: false)
	dist project(path: ':osgi:database:sql-jdbc-service:', transitive: false)
	dist project(path: ':osgi:database:sql-scheduler:', transitive: false)
	dist project(path: ':osgi:database:sql-scheduler-web:', transitive: false)

	dist project(path: ':osgi:database:repository-http-api:', transitive: false)
	dist project(path: ':osgi:database:repository-http-service:', transitive: false)

	dist project(path: ':osgi:schema-registry:schema-registry-service', transitive: false)
	dist project(path: ':osgi:schema-registry:schema-registry-api', transitive: false)
	dist project(path: 'osgi:schema-registry:schema-registry-avro', transitive: false)
	dist project(path: ':osgi:datasource:datasource-api', transitive: false)
	dist project(path: ':osgi:datasource:datasource-service', transitive: false)
	dist project(path: ':osgi:datasource:datasource-web', transitive: false)
	dist project(path: ':osgi:search:search-api', transitive: false)
	dist project(path: ':osgi:search:search-service', transitive: false)
	dist project(path: ':osgi:search:search-client-api', transitive: false)
	dist project(path: ':osgi:search:search-client-service', transitive: false)
	dist project(path: ':osgi:search:search-enrich-service', transitive: false)
	dist project(path: ':osgi:search:search-enrich-api', transitive: false)
	dist project(path: ':osgi:search:search-enrich-mapper-service', transitive: false)
	dist project(path: ':osgi:search:search-enrich-mapper-api', transitive: false)
	dist project(path: ':osgi:metrics:metrics-api', transitive: false)
	dist project(path: ':osgi:metrics:metrics-service', transitive: false)
	dist project(path: ':osgi:metrics:metrics-ext', transitive: false)

	//dist project(path: ':plugins:email', transitive: false)
	//dist project(path: ':plugins:liferay', transitive: false)
	dist project(path: ':plugins:web', transitive: false)

	// felix dependency manager

	distExternal group: 'org.apache.felix', name: 'org.apache.felix.dependencymanager', version: '4.6.0' , transitive: false
	distExternal group: 'org.apache.felix', name: 'org.apache.felix.dependencymanager.shell', version: '4.0.8' , transitive: false
	distExternal group: 'org.apache.felix', name: 'org.apache.felix.dependencymanager.runtime', version: '4.0.7' , transitive: false

	dist project(path: ':osgi:init-data', transitive: false)

}


def allDependencies = configurations
		.findAll({it.name.startsWith("dist")})
		.collect({ it.dependencies})
		.flatten()

def conf = configurations.create("tmp")

conf.dependencies.addAll(allDependencies)

task buildDist(type: Copy) {
	from(conf)
	into "$rootDir/build/libs"
}

if (properties.get("karafDir") != null) {
	task deployDist(type: Copy) {
		from(conf)
		into "$karafDir/deploy"
	}
}
task cleanDist(type: Delete) {
	delete("$rootDir/build")
}

clean.dependsOn(cleanDist)